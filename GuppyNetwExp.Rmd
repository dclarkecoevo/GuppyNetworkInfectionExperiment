
---
title: "Guppy Network Infection Experiment"
author:
- David R. Clark
- Jason Walsman
- Faith Rovenolt
- Jessica Stephenson
date: "01/31/2023"
output:
  pdf_document:
    toc: yes
    number_sections: yes
  editor_options:
    chunk_output_type: console
  word_document:
    toc: yes
header-includes:
- \usepackage{caption}
- \captionsetup[figure]{labelformat=empty}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=70), tidy=TRUE)
```

\section{Introduction}

\subsection{Overall summary}

This is an analysis to examine how host traits, particularly host sociality and sex, impacts the spread of disease within experimental epidemics of Trinidadian guppies and Monogenean parasites. 

\subsection{Quick experimental summary}

We released 6 female guppies and 3 male guppies into experimental behavioral enclosures together and recorded their baseline sociality (Here defined as Contact Rate) for 2 days. We then introduced an infected female index fish on day 3 to see how quickly parasites spread within the group of fish and how likely specific individuals to pick up parasite infection. We repeated recording behavior for 7 days post infection for a total of 9 days of behavioral recordings, however the analysis within this document is limited to days 1-3. 

\subsection{Questions}

\subsubsection{Individual level}

- Is how infected an individual is mean it will have less contacts? 

-Are hosts with higher contact rate more likely to become infected?

-Does index infection load also predict the transmission of parasites?

-Do both these factors together better predict parasite spread than either alone?

-Does host sex variation lead to unequal likelihood of acquiring parasites during epidemic spread?

-Do hosts change their sociality with the introduction of infectious agents during an epidemic?

-Is there sex variation in the change in sociality as an epidemic starts?

\subsection{Data description, structure and type}

This analysis uses a single master data frame titled: IndividualContacts_20240719.csv that is subset into different portions based on what questions/analysis we are addressing. You'll find the subset for each section at the start of each analysis section. Variables within the data frame as follows:

\textbf{population}: The population code for the population the fish was born in (the first two letters of the code) and the infection treatment of the population(last 3 letters of the code). Ex: ADinf - population AD - infection treatment inf. \newline
\textbf{fishID}: The fish identification number for each pop. Range is 1-10 and repeats for each population.\newline
\textbf{day}: The day of the behavior for each fish. Range is 1-3. Days 1-2 are uninfected days while day 3 has either an infected or sham infected individual.\newline
\textbf{TotalContactR}: The total contact rate for each fish per day. This is both contacts initiated by the individual and contacts received for the individual. This is measured in frames a fish was in contact with a fish/total number of frames in the behavior video. \newline
\textbf{Contactinit}: The contact rate for contacts initiated by each fish per day. This is measured in frames a fish was in contact with a fish/total number of frames in the behavior video. \newline
\textbf{Sex}: The sex of each individual. 2 levels, F-female, M-male\newline
\textbf{worms}: The amount of worms on each fish at the end of Day 3.\newline
\textbf{IndexWorm}: The amount of worms on the index fish during Day 3.\newline
\textbf{InfectionTrt}: The amount of worms on the index fish during Day 3.\newline
\textbf{ContactwoI}: The contact rate of each fish with all individuals who are not the index fish during Day 3. This is the frames of each fish's initiated contacts/total number of frames in a video. \newline
\textbf{IndexContact_init}: The contact rate of each fish with the index fish during Day 3. This is the frames of each fish's initiated contacts with the index fish/total number of frames in a video.\newline
\textbf{Infectionstat}: The infection status of each fish at the end of Day 3 counts. 2 levels, 1-infected, 0-uninfected\newline
\textbf{wormcontact}: The number of initiated contact rate for each fish multiplied by the number of worms present in the tank during day 3.\newline
\textbf{Index}: Whether or not each fish was the index fish. 2 levels, 0-not index, 1 - index\newline

```{r importing data and defining key metrics and loading libraries, warning=F,message=FALSE}
#Load in libraries for analysis and data wrangling
#Visualization
library(ggplot2)
library(visreg)
source("http://highstat.com/Books/BGS/GAMM/RCodeP2/HighstatLibV6.R")
#(generalized) Linear mixed modeling
library(lme4)
library(glmmTMB)
#Statistcal analysis reporting and model validation
library(performance)
library(car)
library(lmtest)
library(DHARMa)
#Data wrangling
library(dplyr)
library(plyr)
library(tidyverse)
library(emmeans)

#Importing the master data sheet check intro for description of factors
#Choose X datasheet (specify when finished)
PopulationContacts<-read.csv("IndividualContacts_20240719.csv")

#Set data strcuture for some factors

PopulationContacts<-PopulationContacts%>%
  select(-c(X))

#Setting Day as a factor instead of a numeric
PopulationContacts$Day<-as.factor(PopulationContacts$day)
#Setting whether a fish was an index (intitial infection) or not as factor
PopulationContacts$Index<-as.factor(PopulationContacts$Index)
#Setting whether an fish was infected or not as factor 
PopulationContacts$Infectionstat<-as.factor(PopulationContacts$Infectionstat)
#Setting whether the day was an infected versus uninfected treatment as factor
PopulationContacts$InfectionTrt<-as.factor(PopulationContacts$InfectionTrt)
#Setting whether fish were male or female as a factor#InfectionstatSetting whether fish were male or female as a factor
PopulationContacts$Sex<-as.factor(PopulationContacts$Sex)
#Setting population the fish were from as a factor
PopulationContacts$population<-as.factor(PopulationContacts$population)

```


\section{Individual Level Analysis}


\subsection{Do hosts contact index fish infected with worms less than those without worms>}

\subsubsection{Filtering down to index individuals on day 3}
```{r selection and subseting to data needed for index worm and contact analysis, warning=F}
#Filtering down to only 
#Getting index contact rate
IndividualInfDFIn<-PopulationContacts %>%
  filter(Index == "1" & day == "3")%>%
  mutate(ContactRec = TotalContactR - Contactinit)


```

```{r fit a model looking at contact with index with and without worms}

cpsex=c("darkseagreen4","lightsalmon3")

cpinf=c("cornsilk4","brown4")
#fitting a model for contacts initiated by infection treatment 
IndexContacts<-glm(Contactinit~InfectionTrt, family=Gamma(link="log"), IndividualInfDFIn )
#Looking at the summary of the model
summary(IndexContacts)
#Anova to test for significance 
Anova(IndexContacts, type=2)
#Check model fit for any validation problems. 
check_model(IndexContacts)

IndexContactsVR<-visreg(IndexContacts, "InfectionTrt", scale="response", plot=FALSE)

IndexContactsVRfit<-IndexContactsVR$fit
IndexContactsVRres<-IndexContactsVR$res

ggplot(IndexContactsVRres, aes(x=InfectionTrt, y=visregRes, fill=InfectionTrt))+geom_boxplot(outliers=FALSE)+geom_jitter()+ylab("Contacts initiated by index")+xlab("Infection Treatment")+theme_classic()+theme(text=element_text(size=18))+theme(legend.position="none")+scale_fill_manual(values=cpinf)



```


```{r fit a model looking at contact with index with and without worms}
#Fitting a model to test for differences in contacts received by infection
IndexContactsRec<-glm(ContactRec~InfectionTrt, family=Gamma(link="log"), IndividualInfDFIn)
#Looking at the summary of the model to see the relationship
summary(IndexContactsRec)
#Using a type 2 ANOVA to test for significance
Anova(IndexContactsRec, type=2)
#Check model validation
check_model(IndexContactsRec)

IndexContactsRecVR<-visreg(IndexContactsRec, "InfectionTrt", scale="response", plot=FALSE)

IndexContactsRecVRfit<-IndexContactsRecVR$fit
IndexContactsRecVRres<-IndexContactsRecVR$res



ggplot(IndexContactsRecVRres, aes(x=InfectionTrt, y=visregRes, fill=InfectionTrt))+geom_boxplot(outliers=FALSE)+geom_jitter()+ylab("Contacts recevied by index")+xlab("Infection Treatment")+theme_classic()+theme(text=element_text(size=18))+theme(legend.position="none")+scale_fill_manual(values=cpinf)


```
\subsection{Do index with more worms contact other hosts more or receive less contacts overall?}

```{r fitting a linear model to test for contact inititation by parasite abundance}

IndexInfected<-IndividualInfDFIn %>%
  filter(Infectionstat == "1")

#fitting a model for contacts initiated by infection treatment 
IndexwormContacts<-glm(Contactinit~IndexWorm, family=Gamma(link="log"), IndexInfected )
#Looking at the summary of the model
summary(IndexwormContacts)
#Anova to test for significance 
Anova(IndexwormContacts, type=2)
#Check model fit for any validation problems. 
check_model(IndexwormContacts)


#plotting the relationship
IndexwormInfVR<-visreg(IndexwormContacts, "IndexWorm", scale="response", gg=TRUE, rug=FALSE)+geom_point()+theme_classic()+ylab("Initiated contact rate by index")+xlab("Number of worms on index")+theme(text=element_text(size=18))

print(IndexwormInfVR)

```

```{r fitting a linear model to test for contact inititation by parasite abundance}

#fitting a model for contacts initiated by infection treatment 
IndexwormContactsRec<-glm(ContactRec~IndexWorm, family=Gamma(link="log"), IndexInfected )
#Looking at the summary of the model
summary(IndexwormContactsRec)
#Anova to test for significance 
Anova(IndexwormContactsRec, type=2)
#Check model fit for any validation problems. 
check_model(IndexwormContactsRec)


#plotting the relationship
IndexwormInfRecVR<-visreg(IndexwormContactsRec, "IndexWorm", scale="response", gg=TRUE, rug=FALSE)+geom_point()+theme_classic()+ylab("Chance of infection on Day 3")+xlab("Number of worms on index")+theme(text=element_text(size=18))

print(IndexwormInfRecVR)

```

\subsubsection{Are hosts with higher contact rate more likely to become infected?}

For this first bit we need to select the data we need to answer this specific question
```{r selection and subseting to data needed for this analysis, warning=F}
#Filtering down to only infected treatments, individuals who are not the index, one measure per fish and days 2 and 3. Note the days 2 and 3 is because intitial viewing of behaviors across days looks like fish were not behaving normally on day 1 due to acclimation to the new environment.
IndividualInfDF<-PopulationContacts%>%
  filter(Index == "0")%>%
  filter(Day == 2 | Day == 3)
#Making sure the filtering worked. Commented out for overall ease of running
#summary(IndividualInfDF)

#Creating a dataframe for day 3 only
IndividualInfDFD3<-IndividualInfDF%>%
  filter(Day==3)

#Creating a dataframe for day 2 only
IndividualInfDFD2<-IndividualInfDF%>%
  filter(Day==2)

```

\subsubsection{Now we need to examine correlation between variables}
```{r visual and correlational test for autocorrelation for models, warning=F}

pairs(~Contactinit+Sex+Infectionstat+IndexWorm+worms+InfectionTrt, lower.panel=panel.smooth, diag.panel=panel.hist, 
upper.panel=panel.cor, data=IndividualInfDF)

```

\subsubsection{Fitting the contact rate versus probability of infection model}

We're fitting a binomial generalized linear mixed model with sex and the day 2 contact rate as predictor variables and whether or not a host became infected as the response. We have population as a random effect to control for non-independence of contact rate between individauls within the same group.

```{r fitting the glmmTMB for prob of infection and contact rate, warnging=F}

#Linear model to determine if individual sociality explained the probability of becoming infected

InfCRlm<-glmmTMB(Infectionstat~Contactinit+Sex+CRinitCh+(1|population),  IndividualInfDFD2, family=binomial())


#Summary of fitted model parameters
summary(InfCRlm)


```

\subsubsection{Next we see will validate the model to make sure everything is looking good.}

```{r model validation for prob of infection vs ContactRate, warning=F}
#Using DHARMa package to look at quantile residuals to validate the model fit
sim_residuals_InfCRlm <-simulateResiduals(InfCRlm, 1000)  #Quantile residuals
#Ploting the quantile residuals
plot(sim_residuals_InfCRlm)
#Testing dispersion
testDispersion(sim_residuals_InfCRlm)

#Below we are exmaining the quantile residuals among the fixed variables to see if there are any funky patterns. Excluded from main run for space but remove # to see plots
#plotResiduals(sim_residuals_InfCRlm, IndividualInfDFD2$Sex)
#plotResiduals(sim_residuals_InfCRlm, IndividualInfDFD2$ContactRate)
```


Model validation looks good!

\subsubsection{Likelihood ratio test to test for significance in our model}

```{r Likelihood ratio test for prob of inf with Sociality, warning=F}
# #Drop 1 with chisq test to do a likelihood ratio test for our model
 drop1(InfCRlm, test="Chisq")

```

\subsubsection{Visualization of the relationships between variables}

```{r Visualization of the relation for prob inf and contactrate, warning=F}
# #Visreg of contact rate effect
#
InfSxlmVR<-visreg(InfCRlm, "Sex", scale="response", partial=TRUE, plot=FALSE)

InfSxlmVRfit<-InfSxlmVR$fit
InfSxlmVRres<-InfSxlmVR$res


ggplot(InfSxlmVRres, aes(x=Sex, visregRes, fill=Sex))+geom_boxplot()+geom_jitter()+theme_classic()+theme(text=element_text(size=20))+xlab(" ")+ylab("Chance of infection on Day 3")+scale_fill_manual(values=cpsex)+theme(legend.position="none")+scale_x_discrete(breaks=c("F","M"),
      labels=c("Females", "Males"))

```


```{r Visualization of the relation for prob inf and sex, warning=F}
# #Visreg of contact rate effect
#
InfCRlmVR<-visreg(InfCRlm, "CRinitCh", scale="response", partial=TRUE, gg=TRUE, rug=FALSE)+xlab("Change in initiated contact rate")+ylab("Chance of infection on Day 3")+theme_classic()+theme(text=element_text(size=20))

print(InfCRlmVR)

```



\subsubsection{Quick test to see how correlated Day 2 and Day 3 contact rates are for populations}

```{r qucik correlation plot/analysis to ensure day 2 sociality lines up with day 3 and we should repeat this analysis with day 3, warning=F}
# #I am putting all this code together since its just a verification step instead of each part having its own section.
# #Subsetting and pivoting to what we want
# IndividualInfDFcorr<-PopulationContacts%>%
#   filter(Treatment == "Inf")%>%
#   filter(Index == "0")%>%
#   filter(Day == 2 | Day == 3)%>%
#   select(-c(Day3ContactRatewoI,IndexContact,Popavg,Pop,Treatment,TempTreatment, Sex, Inf.,worms,prev,IndexWorm,Index,ChConWithIn, ChConWOIn,ChConPop,PreSVL,PreWeight,PostSVL,PostWeight,WormContact))%>%
#   pivot_wider(names_from=Day, values_from = ContactRate)%>%
#   dplyr::rename("Day2"="2")%>%
#   dplyr::rename("Day3"="3")
# #Quick linear model to see how correlated they are
# CRcorr<-lm(Day2~Day3,IndividualInfDFcorr)
# #Summary showing significant positive relationship
# summary(CRcorr)
# #Correlation test to show cor value
# cor.test(x=IndividualInfDFcorr$Day2,y=IndividualInfDFcorr$Day3)
# 

```

Test shows they are pretty correlated so no need to repeat the analysis with day 3 sociality. Code is commented out for ease of viewing the document.


\subsection{Does index infection load also predict the transmission of parasites?}


Next we need to subset specifically to the infection loads of the group and what it means for probability of transmission. Given each group only had one index load, the linear model will give us group means and how it predicts prevalence.

```{r selection and subseting to data needed for infection load versus probability of transmission}
#Filtering down to only infected treatments, individuals who are not the index, one measure per fish and days 2 and 3. Note the days 2 and 3 is because intitial viewing of behaviors across days looks like fish were not behaving normally on day 1 due to acclimation to the new environment.
IndividualInfDF<-PopulationContacts%>%
  filter(InfectionTrt == "1")%>%
  filter(Index == "0")%>%
  filter(Day == 2 | Day == 3)
#Making sure the filtering worked. Commented out for overall ease of running
#summary(IndividualInfDF)

#Creating a dataframe for day 3 only
IndividualInfDFD3<-IndividualInfDF%>%
  filter(Day==3)
```


\subsubsection{Now we need to examine correlation between variables}

```{r visual and correlational test for autocorrelation for Probability of infection and index infection load, warning=F}

pairs(~Contactinit+Sex+Infectionstat+IndexWorm+worms+InfectionTrt, lower.panel=panel.smooth, diag.panel=panel.hist, 
upper.panel=panel.cor, data=IndividualInfDF)

```

\subsubsection{Fitting the probability of infection versus Infection load model}

We're fitting a binomial generalized linear mixed model with sex and the index infection load as predictor variables and whether or not a host became infected as the response. We have population as a random effect to control for non-independence of index infection load between individauls within the same group.

```{r fitting the glmmTMB for prob of infection and Index Worm load}

#Linear model to determine if individual sociality explained the probability of becoming infected

InfbyIndexWlm<-glmmTMB(Infectionstat~IndexWorm+Sex:IndexContact_init+(1|population),  IndividualInfDFD3, family=binomial)

#Summary of fitted model parameters
summary(InfbyIndexWlm)

```

\subsubsection{Next we see will validate the infeciton by index worm model to make sure everything is looking good.}

```{r model validation for prob of infection vs Index worm burden}
#Using DHARMa package to look at quantile residuals to validate the model fit
sim_residuals_InfbyIndexWlm <-simulateResiduals(InfbyIndexWlm, 1000)  #Quantile residuals
#Ploting the quantile residuals
plot(sim_residuals_InfbyIndexWlm) 
#Testing dispersion
testDispersion(sim_residuals_InfbyIndexWlm)

#Below we are exmaining the quantile residuals among the fixed variables to see if there are any funky patterns. Excluded from main run for space but remove # to see plots
#plotResiduals(sim_residuals_InfCRlm, IndividualInfDFD2$Sex)
#plotResiduals(sim_residuals_InfCRlm, IndividualInfDFD2$IndexWorm)
```

Infection by Index worm model validation looks good!

\subsubsection{Likelihood ratio test to test for significance of our fixed effects in the model}

```{r Likelihood ratio test for prob of inf with IndexWorm}
#Drop 1 with chisq test to do a likelihood ratio test for our model
drop1(InfbyIndexWlm, test="Chisq")


```

\subsubsection{Visualization of the relationships between probability of infection and host sociality}

```{r Visualization of the relation for prob inf and IndexWorm load/sex}
#Visual examination of the partial residuals and fit of the model for Index worm
InfIWvr<-visreg(InfbyIndexWlm, "IndexWorm", scale="response", partial=T, rug=FALSE, gg=TRUE)+geom_point()+xlab("Number of worms on index fish")+ylab("Chance of being infected on Day 3")+theme_classic()+theme(text=element_text(size=18))
print(InfIWvr)


#Plotting the relationship of probability of infection by IndexWorm and sex
InfIWxSxvr<-visreg(InfbyIndexWlm, "IndexContact_init", "Sex", scale="response", rug=FALSE, gg=TRUE, overlap=TRUE)+geom_point()+xlab("Initated contact with index rate")+ylab("Chance of being infected on Day 3")+theme_classic()+theme(text=element_text(size=18))
print(InfIWxSxvr)

```

Overall we are seeing that Infection load does a better job at predicting the transmission of parasites relative to contact rate of the individual. Current literature suggests that mechanistically the transmission of parasites is a combination of both of these traits so next we should see what their additive effect is on an individauls likelihood of transmission

\subsection{Do both these factors together better predict parasite spread than either alone?}

```{r selection and subseting to data needed for the combination of index worm and contact rate}
#Filtering down to only infected treatments, individuals who are not the index, one measure per fish and days 2 and 3. Note the days 2 and 3 is because intitial viewing of behaviors across days looks like fish were not behaving normally on day 1 due to acclimation to the new environment.
IndividualInfWCDF<-PopulationContacts%>%
  filter(Day == 3)%>%
  filter(InfectionTrt == "1")%>%
  filter(Index == "0")
#Making sure the filtering worked. Commented out for overall ease of running
#summary(IndividualInfWCDF)


```


\subsubsection{Now we need to examine correlation between variables for this set of the analysis}


```{r visual and correlational test for autocorrelation for WormContact models, warning=F}

pairs(~Infectionstat+wormcontact+Sex, lower.panel=panel.smooth, diag.panel=panel.hist, 
upper.panel=panel.cor, data=IndividualInfWCDF)

```

\subsubsection{Fitting the  probability of infection versus Index worm by contact rate model}

We're fitting a binomial generalized linear mixed model with sex and the index infection load multiplied by contact rate (hereafter WormContact) as predictor variables and whether or not a host became infected as the response. We have population as a random effect to control for non-independence of WormContact between individauls within the same group.

```{r fitting the glmmTMB for prob of infection and WormContact load}

#Linear model to determine if WormContact explained the probability of becoming infected

InfbyWClm<-glmmTMB(Infectionstat~wormcontact+Sex+(1|population),  IndividualInfWCDF, family=binomial)

#Summary of fitted model parameters
summary(InfbyWClm)

```


\subsubsection{Next we see will validate the model to make sure everything is looking good.}

```{r model validation for prob of infection vs WormContact}
#Using DHARMa package to look at quantile residuals to validate the model fit
sim_residuals_InfWClm <-simulateResiduals(InfbyWClm, 1000)  #Quantile residuals
#Ploting the quantile residuals
plot(sim_residuals_InfWClm) 
#Testing dispersion
testDispersion(sim_residuals_InfWClm)

#Below we are exmaining the quantile residuals among the fixed variables to see if there are any funky patterns. Excluded from main run for space but remove # to see plots
#plotResiduals(sim_residuals_InfCRlm, IndividualInfDFD2$Sex)
#plotResiduals(sim_residuals_InfCRlm, IndividualInfDFD2$ContactRate)
```



While the model validation shows a little deviation from quantile range, it still looks pretty good. We can continue with the analysis.

\subsubsection{Likelihood ratio test to test for significance of our fixed effects in the model}

```{r Likelihood ratio test for prob of inf with WormContact}
#Drop 1 with chisq test to do a likelihood ratio test for our model
drop1(InfbyWClm, test="Chisq")

```


\subsubsection{Visualization of the relationships between probability of infection and the contact rate of hosts multiplied by index worm load}

```{r Visualization of the relation for prob inf and WormContact/sex}
#Visual examination of the partial residuals and fit of the model for Index worm
InfWCvr<-visreg(InfbyWClm, "wormcontact", scale="response", partial=T, rug=FALSE, gg=TRUE)+geom_point()+xlab("Index worm load*Contact Rate")+ylab("Chance of being infected on Day 3")+theme_classic()+theme(text=element_text(size=18))
print(InfWCvr)


#Plotting the relationship of probability of infection by WormContact and sex
InfWCxSxVR<-visreg(InfbyIndexWlm, "Sex", scale="response", rug=FALSE, plot=FALSE)

InfWCxSxVRfit<-InfWCxSxVR$fit
InfWCxSxVRres<-InfWCxSxVR$res

ggplot(InfWCxSxVRres, aes(x=Sex, y=visregRes))+geom_boxplot()+geom_jitter()+xlab(" ")+ylab("Chance of being infected on Day 3")+theme_classic()+theme(text=element_text(size=18))


```

Worm Contacts does a relatively good job fitting the data. However we need to check and see if it actually does better than the other two models we fit trying to predict the probability of transmission

\subsubsection{AIC model selection to see which model has the best fit to our data}

```{r AIC model selection to determine which model is best fit for our data}

#AIC model selection to determine which model is the best fit for our data
AIC(InfbyWClm, InfbyIndexWlm, InfCRlm)

```

Overall, AIC model selection is showing that the probability of infection model with index worm load is a better fit overall than both the other candidates. The AIC for our index infection burden model is greater than two difference than either model so it seems that best predicts the transmission of parasites. 

\section{Testing for whether individual hosts changed their total contact rate between days 2 and 3 more for infected populations relative to uninfected populations}
```{r subseting to the data needed to test for change in beahvior between days 2 and 3}

#Subsetting down to one row per fish
PopCRCh<-PopulationContacts%>%
  group_by(population)%>%
  distinct(fishID, .keep_all=TRUE)


```

\subsection{Fitting a model to test for important factors in the change in behaivor}

```{r Fitting a model to test for important factors in the change in behaivor}

ChBehavTotLM<-lmer(TotalCRCh~InfectionTrt*Sex+(1|population), PopCRCh)

summary(ChBehavTotLM)

```

\subsection{Next we see will validate the model to make sure everything is looking good.}

```{r model validation for prob of infection vs WormContact}
#Using DHARMa package to look at quantile residuals to validate the model fit
sim_residuals_ChBehavTotLM<-simulateResiduals(ChBehavTotLM, 1000)  #Quantile residuals
#Ploting the quantile residuals
plot(sim_residuals_ChBehavTotLM) 
#Testing dispersion
testDispersion(sim_residuals_ChBehavTotLM)

#Below we are exmaining the quantile residuals among the fixed variables to see if there are any funky patterns. Excluded from main run for space but remove # to see plots
#plotResiduals(sim_residuals_InfCRlm, IndividualInfDFD2$Sex)
#plotResiduals(sim_residuals_InfCRlm, IndividualInfDFD2$ContactRate)
```

\subsection{F test to test for significance of our fixed effects in the model}

```{r Likelihood ratio test for prob of inf with WormContact}
#Drop 1 with chisq test to do a likelihood ratio test for our model
Anova(ChBehavTotLM, type=3, test="F")

```

\subsection{Visualizing the relationship between variables and total change in behavior}

```{r visualizing the relationship between variables and total change in behavior}

ChBehavTotLMVR<-visreg(ChBehavTotLM, "Sex", partial=T, scale="response", plot=FALSE)

ChBehavTotLMVRfit<-ChBehavTotLMVR$fit
ChBehavTotLMres<-ChBehavTotLMVR$res


ggplot(ChBehavTotLMres, aes(x=Sex, y=visregRes))+geom_boxplot( outliers=FALSE)+geom_jitter()+theme_classic()+ylab("Change in behavior after infection")+xlab(" ")+theme(text=element_text(size=18))+geom_hline(yintercept=0, linetype="dashed")
```
\section{Testing for whether individual hosts changed their initiated contact rate between days 2 and 3 more for infected populations relative to uninfected populations}

\subsection{Fitting a model to test for important factors in the change in initated  contact rate}

```{r Fitting a model to test for important factors in the change in behaivor}

ChBehavTotinitLM<-lmer(CRinitCh~InfectionTrt*Sex+(1|population), PopCRCh)

summary(ChBehavTotinitLM)

```
\subsection{Next we see will validate the model to make sure everything is looking good.}

```{r model validation for prob of infection vs WormContact}
#Using DHARMa package to look at quantile residuals to validate the model fit
sim_residuals_ChBehavTotinitLM<-simulateResiduals(ChBehavTotinitLM, 1000)  #Quantile residuals
#Ploting the quantile residuals
plot(sim_residuals_ChBehavTotinitLM) 
#Testing dispersion
testDispersion(sim_residuals_ChBehavTotinitLM)

#Below we are exmaining the quantile residuals among the fixed variables to see if there are any funky patterns. Excluded from main run for space but remove # to see plots
#plotResiduals(sim_residuals_InfCRlm, IndividualInfDFD2$Sex)
#plotResiduals(sim_residuals_InfCRlm, IndividualInfDFD2$ContactRate)
```

\subsection{F test to test for significance of our fixed effects in the model}

```{r Likelihood ratio test for prob of inf with WormContact}
#Drop 1 with chisq test to do a likelihood ratio test for our model
Anova(ChBehavTotinitLM, type=3, test="F")

```


\section{Testing for whether individual hosts changed their total contact rate between days 2 and 3 more for infected populations with index with more intense infections}



\subsection{Fitting a model to test for important factors in the change in total contact rate for infected populations only}

```{r Fitting a model to test for important factors in the change in behaivor}
PopCRChI<-PopCRCh%>%
  filter(InfectionTrt=="1")


ChBehavTotinfLM<-lmer(TotalCRCh~IndexWorm+Sex++(1|population), PopCRChI)

summary(ChBehavTotinfLM)

```

\subsection{Next we see will validate the model to make sure everything is looking good.}

```{r model validation for prob of infection vs WormContact}
#Using DHARMa package to look at quantile residuals to validate the model fit
sim_residuals_ChBehavTotinfLM<-simulateResiduals(ChBehavTotinfLM, 1000)  #Quantile residuals
#Ploting the quantile residuals
plot(sim_residuals_ChBehavTotinfLM) 
#Testing dispersion
testDispersion(sim_residuals_ChBehavTotinfLM)

#Below we are exmaining the quantile residuals among the fixed variables to see if there are any funky patterns. Excluded from main run for space but remove # to see plots
#plotResiduals(sim_residuals_InfCRlm, IndividualInfDFD2$Sex)
#plotResiduals(sim_residuals_InfCRlm, IndividualInfDFD2$ContactRate)
```


\subsection{F test to test for significance of our fixed effects in the model}

```{r Likelihood ratio test for prob of inf with WormContact}
#Drop 1 with chisq test to do a likelihood ratio test for our model
Anova(ChBehavTotinfLM, type=3, test="F")

```

\section{Testing for whether individual hosts changed their total initiated rate between days 2 and 3 more for infected populations with index with more intense infections}



\subsection{Fitting a model to test for important factors in the change in total contact rate for infected populations only}

```{r Fitting a model to test for important factors in the change in behaivor}

ChBehavinitinfLM<-lmer(CRinitCh~IndexWorm*Sex+(1|population), PopCRChI)

summary(ChBehavinitinfLM)

```

\subsection{Next we see will validate the model to make sure everything is looking good.}

```{r model validation for prob of infection vs WormContact}
#Using DHARMa package to look at quantile residuals to validate the model fit
sim_residuals_ChBehavinitinfLM<-simulateResiduals(ChBehavinitinfLM, 1000)  #Quantile residuals
#Ploting the quantile residuals
plot(sim_residuals_ChBehavinitinfLM) 
#Testing dispersion
testDispersion(sim_residuals_ChBehavinitinfLM)

#Below we are exmaining the quantile residuals among the fixed variables to see if there are any funky patterns. Excluded from main run for space but remove # to see plots
#plotResiduals(sim_residuals_InfCRlm, IndividualInfDFD2$Sex)
#plotResiduals(sim_residuals_InfCRlm, IndividualInfDFD2$ContactRate)
```


\subsection{F test to test for significance of our fixed effects in the model}

```{r Likelihood ratio test for prob of inf with WormContact}
#Drop 1 with chisq test to do a likelihood ratio test for our model
Anova(ChBehavinitinfLM, type=3, test="F")

```